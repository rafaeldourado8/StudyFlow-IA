name: Deploy Backend to EC2

on:
  push:
    branches: [production]
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - 'nginx/**'
      - '.github/workflows/deploy-backend.yml'

env:
  PROJECT_DIR: /home/ubuntu/studyflow-ia
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ðŸ“ Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USERNAME }}
        run: |
          ssh $USER@$HOST << 'ENDSSH'
            set -e
            
            echo "ðŸ“‚ Navegando para o diretÃ³rio do projeto..."
            cd ${{ env.PROJECT_DIR }}
            
            echo "ðŸ”„ Atualizando cÃ³digo..."
            git fetch origin
            git checkout production
            git pull origin production
            
            echo "ðŸ“ Criando arquivo .env de produÃ§Ã£o..."
            cat > .env << 'EOF'
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=0
          ALLOWED_HOSTS=localhost,127.0.0.1,backend,nginx,${{ secrets.EC2_HOST }}
          
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=postgres_db
          DB_PORT=5432
          
          RABBITMQ_DEFAULT_USER=${{ secrets.RABBITMQ_DEFAULT_USER }}
          RABBITMQ_DEFAULT_PASS=${{ secrets.RABBITMQ_DEFAULT_PASS }}
          RABBITMQ_VHOST=/
          
          REDIS_HOST=redis_cache
          REDIS_PORT=6379
          
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          
          CELERY_BROKER_URL=amqp://${{ secrets.RABBITMQ_DEFAULT_USER }}:${{ secrets.RABBITMQ_DEFAULT_PASS }}@rabbitmq:5672//
          CELERY_RESULT_BACKEND=db+postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres_db:5432/${{ secrets.POSTGRES_DB }}
          EOF
            
            echo "ðŸ³ Parando containers existentes..."
            docker-compose down
            
            echo "ðŸ—ï¸ Reconstruindo imagens..."
            docker-compose build --no-cache backend backend_worker
            
            echo "ðŸš€ Iniciando serviÃ§os..."
            docker-compose up -d
            
            echo "â³ Aguardando serviÃ§os ficarem prontos..."
            sleep 30
            
            echo "ðŸ” Verificando status dos containers..."
            docker-compose ps
            
            echo "ðŸ“Š Logs recentes do backend:"
            docker-compose logs --tail=50 backend
            
            echo "âœ… Deploy concluÃ­do!"
          ENDSSH

      - name: ðŸ§ª Health Check
        run: |
          echo "ðŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
          sleep 10
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/api/auth/login/ || echo "000")
          
          if [ "$response" -eq "200" ] || [ "$response" -eq "405" ]; then
            echo "âœ… API estÃ¡ respondendo corretamente (HTTP $response)"
          else
            echo "âŒ API nÃ£o estÃ¡ respondendo corretamente (HTTP $response)"
            exit 1
          fi

      - name: ðŸ“¢ Notify Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deploy realizado com sucesso!"
          echo "ðŸŒ Backend disponÃ­vel em: http://${{ secrets.EC2_HOST }}"
          echo "ðŸ“š API Docs: http://${{ secrets.EC2_HOST }}/api/schema/swagger-ui/"

      - name: ðŸ“¢ Notify Failure
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs acima."